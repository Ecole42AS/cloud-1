---
# ===================================
# Rôle Ansible : cloud-1
# Déploiement de la stack WordPress
# ===================================

# Ce fichier contient toutes les tâches pour déployer l'application



# =============================
# Étape 9 : Création du répertoire de déploiement
# =============================
- name: Créer le répertoire de travail
  ansible.builtin.file:
    path: "{{ cloud1_project_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  become: yes
  # Ce dossier contiendra docker-compose.yml, .env et nginx.conf
  # owner/group: appartient à l'utilisateur SSH (ubuntu)
  # mode 0755: lecture/écriture pour le propriétaire, lecture pour les autres

# =============================
# Étape 10 : Copie de docker-compose.yml
# =============================
- name: Copier docker-compose.yml vers le serveur
  ansible.builtin.copy:
    src: docker-compose.yml
    dest: "{{ cloud1_project_dir }}/docker-compose.yml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
  become: yes
  # src: chemin relatif depuis le rôle vers la racine du projet
  # dest: destination sur le serveur distant
  # mode 0644: lecture/écriture propriétaire, lecture pour les autres

# =============================
# Étape 11 : Copie du fichier .env
# =============================
- name: Deploy .env from template
  ansible.builtin.template:
    src: env.j2
    dest: "{{ cloud1_project_dir }}/.env"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0600"
  become: yes

# =============================
# Étape 12 : Création du répertoire nginx
# =============================
- name: Créer le répertoire nginx
  ansible.builtin.file:
    path: "{{ cloud1_project_dir }}/nginx"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  become: yes
  # Dossier pour la configuration Nginx

- name: Créer les répertoires de données persistantes
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  loop:
    - "{{ cloud1_project_dir }}/data/db"
    - "{{ cloud1_project_dir }}/data/wordpress"
    - "{{ cloud1_project_dir }}/data/certs"
    - "{{ cloud1_project_dir }}/data/certbot-www"


# =============================
# Étape 13 : Copie de la configuration Nginx
# =============================
- name: Copier nginx.conf vers le serveur
  ansible.builtin.template:
    src: nginx_conf.j2
    dest: "{{ cloud1_project_dir }}/nginx/nginx.conf"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
  become: yes
  # Configuration du reverse proxy Nginx

# =============================
# Étape 15 : Démarrage de la stack Docker
# =============================
- name: Lancer docker compose up -d
  ansible.builtin.shell: docker compose up -d
  args:
    chdir: "{{ cloud1_project_dir }}"
  become: yes
  register: docker_compose_output
  # args.chdir: se place dans /opt/cloud1 avant d'exécuter la commande
  # docker compose up -d: lancer la stack en arrière-plan
  # become: yes: nécessaire pour docker (même si utilisateur dans groupe docker)

# =============================
# Étape 16 : Vérifier que les conteneurs tournent
# =============================
- name: Lister les conteneurs Docker en cours d'exécution
  ansible.builtin.command: docker ps
  register: docker_ps_output
  changed_when: false
  become: yes

- name: Afficher les conteneurs actifs
  ansible.builtin.debug:
    msg: "{{ docker_ps_output.stdout_lines }}"

