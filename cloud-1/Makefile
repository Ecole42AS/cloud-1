# ===================================
# Makefile - Cloud1 WordPress Project
# Gestion Docker + Ansible
# ===================================

# =============================
# Variables de configuration
# =============================

# Configuration Docker/SSL
DOMAIN := mywp-cloud1.duckdns.org
EMAIL := alexandre.stutz@hotmail.com

# Options supplÃ©mentaires pour certbot (ex: --staging ou --force-renewal)
CERTBOT_FLAGS ?=

# Configuration Ansible
ANSIBLE_DIR := ansible
INVENTORY := $(ANSIBLE_DIR)/inventory.ini
PLAYBOOK := $(ANSIBLE_DIR)/playbook.yml

# DÃ©tection automatique du virtualenv Python
VENV_PATH := venv
ifeq ($(shell test -d $(VENV_PATH) && echo yes),yes)
    PYTHON := $(CURDIR)/$(VENV_PATH)/bin/python
    ANSIBLE := $(CURDIR)/$(VENV_PATH)/bin/ansible
    ANSIBLE_PLAYBOOK := $(CURDIR)/$(VENV_PATH)/bin/ansible-playbook
    ANSIBLE_VAULT := $(CURDIR)/$(VENV_PATH)/bin/ansible-vault
else
    PYTHON := python3
    ANSIBLE := ansible
    ANSIBLE_PLAYBOOK := ansible-playbook
    ANSIBLE_VAULT := ansible-vault
endif

# Variables pour commandes ad-hoc Ansible (valeur par dÃ©faut si non spÃ©cifiÃ©es)
HOST ?= all
ARGS ?=

# Couleurs pour l'affichage
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[0;33m
RED := \033[0;31m
NC := \033[0m # No Color

# =============================
# Cible par dÃ©faut
# =============================

.PHONY: help
help: ## Affiche cette aide
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘      Makefile - Cloud1 WordPress Project				   â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(GREEN)ðŸ³ DOCKER - Gestion de la stack WordPress$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; /^[a-zA-Z_-]+:.*?## .*docker/ {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(GREEN)ðŸ”§ ANSIBLE - Commandes ad-hoc$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; /^[a-zA-Z_-]+:.*?## .*ansible ad-hoc/ {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(GREEN)ðŸ“œ ANSIBLE - Playbooks$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; /^[a-zA-Z_-]+:.*?## .*ansible playbook/ {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(GREEN)ðŸ› ï¸  UTILITAIRES$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; /^[a-zA-Z_-]+:.*?## .*util/ {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(BLUE)Exemples d'utilisation :$(NC)"
	@echo "  make init                         # Initialiser SSL pour $(DOMAIN)"
	@echo "  make up                           # DÃ©marrer la stack WordPress"
	@echo "  make ping                         # Tester la connexion Ansible"
	@echo "  make deploy                       # DÃ©ployer avec le playbook"
	@echo "  make shell ARGS=\"uptime\"           # ExÃ©cuter une commande sur le serveur"
	@echo "  make deploy-check                 # Dry-run du dÃ©ploiement"
	@echo ""

# =============================
# DOCKER - Gestion de la stack
# =============================

.PHONY: init
init: ## [ansible] Forcer l'initialisation SSL (via Ansible)
	@echo "$(GREEN)>>> Initialisation SSL forcÃ©e via Ansible$(NC)"
	@cd $(ANSIBLE_DIR) && $(ANSIBLE_PLAYBOOK) -i $(notdir $(INVENTORY)) $(notdir $(PLAYBOOK)) -e "cloud1_letsencrypt_force=true"

.PHONY: logs-nginx
logs-nginx: ## [ansible ad-hoc] Logs Nginx sur la VM (tail -50)
	@cd $(ANSIBLE_DIR) && $(ANSIBLE) -i $(notdir $(INVENTORY)) $(HOST) \
		-m shell -a "cd /opt/cloud1 && docker compose logs --tail=50 nginx"

.PHONY: logs-wordpress
logs-wordpress: ## [ansible ad-hoc] Logs WordPress sur la VM (tail -50)
	@cd $(ANSIBLE_DIR) && $(ANSIBLE) -i $(notdir $(INVENTORY)) $(HOST) \
		-m shell -a "cd /opt/cloud1 && docker compose logs --tail=50 wordpress"

.PHONY: restart-stack
restart-stack: ## [ansible ad-hoc] RedÃ©marrer nginx + wordpress sur la VM
	@cd $(ANSIBLE_DIR) && $(ANSIBLE) -i $(notdir $(INVENTORY)) $(HOST) \
		-m shell -a "cd /opt/cloud1 && docker compose restart nginx wordpress"

.PHONY: certbot-renew
certbot-renew: ## [ansible] Renouveler les certificats (via script distant)
	@echo "$(GREEN)>>> Renouvellement des certificats sur $(HOST)$(NC)"
	@cd $(ANSIBLE_DIR) && $(ANSIBLE) $(HOST) -i $(notdir $(INVENTORY)) -m shell -a "cd /opt/cloud1 && bash scripts/init-letsencrypt.sh $(DOMAIN) $(EMAIL) --force" --become
	@echo "$(GREEN)âœ… Certbot terminÃ©$(NC)"
	@echo "$(YELLOW)Pense Ã  recharger nginx si nÃ©cessaire : make restart-stack$(NC)"


# =============================
# ANSIBLE - Commandes ad-hoc
# =============================

.PHONY: ping
ping: ## [ansible ad-hoc] Tester la connexion Ansible (ping)
	@echo "$(GREEN)>>> Test de connectivitÃ© Ansible$(NC)"
	@cd $(ANSIBLE_DIR) && $(ANSIBLE) -i $(notdir $(INVENTORY)) $(HOST) -m ping

.PHONY: shell
shell: ## [ansible ad-hoc] Ouvrir un shell sur un hÃ´te (HOST=cloud1-vm ARGS="commande")
	@echo "$(GREEN)>>> Ouverture shell sur $(HOST)$(NC)"
	@cd $(ANSIBLE_DIR) && $(ANSIBLE) -i $(notdir $(INVENTORY)) $(HOST) -m shell -a "$(ARGS)"

# =============================
# ANSIBLE - Playbooks
# =============================

.PHONY: deploy
deploy: ## [ansible playbook] ExÃ©cuter le playbook principal
	@echo "$(GREEN)>>> DÃ©ploiement avec Ansible$(NC)"
	@cd $(ANSIBLE_DIR) && $(ANSIBLE_PLAYBOOK) -i $(notdir $(INVENTORY)) $(notdir $(PLAYBOOK))

.PHONY: deploy-check
deploy-check: ## [ansible playbook] Dry-run du playbook (--check)
	@echo "$(BLUE)>>> Simulation du dÃ©ploiement (dry-run)$(NC)"
	@cd $(ANSIBLE_DIR) && $(ANSIBLE_PLAYBOOK) -i $(notdir $(INVENTORY)) $(notdir $(PLAYBOOK)) --check

.PHONY: syntax
syntax: ## [ansible playbook] VÃ©rifier la syntaxe du playbook
	@echo "$(BLUE)>>> VÃ©rification de la syntaxe$(NC)"
	@cd $(ANSIBLE_DIR) && $(ANSIBLE_PLAYBOOK) -i $(notdir $(INVENTORY)) $(notdir $(PLAYBOOK)) --syntax-check
	@echo "$(GREEN)âœ… Syntaxe correcte$(NC)"

.PHONY: vault-encrypt
vault-encrypt: ## [ansible ad-hoc] Chiffrer le fichier vault.yml
	@echo "$(GREEN)>>> Chiffrement de group_vars/all/vault.yml$(NC)"
	@cd $(ANSIBLE_DIR) && $(ANSIBLE_VAULT) encrypt group_vars/all/vault.yml

.PHONY: vault-decrypt
vault-decrypt: ## [ansible ad-hoc] DÃ©chiffrer le fichier vault.yml
	@echo "$(GREEN)>>> DÃ©chiffrement de group_vars/all/vault.yml$(NC)"
	@cd $(ANSIBLE_DIR) && $(ANSIBLE_VAULT) decrypt group_vars/all/vault.yml

# =============================
# UTILITAIRES
# =============================

.PHONY: venv-info
venv-info: ## [util] Afficher les informations sur le virtualenv
	@echo "$(BLUE)Configuration Python/Ansible :$(NC)"
	@echo "  VENV_PATH       : $(VENV_PATH)"
	@echo "  PYTHON          : $(PYTHON)"
	@echo "  ANSIBLE         : $(ANSIBLE)"
	@echo "  ANSIBLE_PLAYBOOK: $(ANSIBLE_PLAYBOOK)"
	@echo ""
	@if [ -d $(VENV_PATH) ]; then \
		echo "$(GREEN)âœ… Virtualenv dÃ©tectÃ©$(NC)"; \
		$(PYTHON) --version; \
		$(ANSIBLE) --version | head -1; \
	else \
		echo "$(YELLOW)âš ï¸  Pas de virtualenv dÃ©tectÃ© - utilisation des commandes systÃ¨me$(NC)"; \
	fi

.PHONY: list-hosts
list-hosts: ## [util] Lister tous les hÃ´tes de l'inventaire
	@echo "$(BLUE)>>> HÃ´tes dans l'inventaire :$(NC)"
	@cd $(ANSIBLE_DIR) && $(ANSIBLE) -i $(notdir $(INVENTORY)) all --list-hosts

.PHONY: status
status: ## [util] Afficher le statut global du projet
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘              STATUS - Cloud1 WordPress Project             â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(GREEN)ðŸ³ Docker Compose :$(NC)"
	@docker compose ps 2>/dev/null || echo "  $(YELLOW)Stack non dÃ©marrÃ©e$(NC)"
	@echo ""
	@echo "$(GREEN)ðŸ”— Connexion Ansible :$(NC)"
	@cd $(ANSIBLE_DIR) && $(ANSIBLE) -i $(notdir $(INVENTORY)) all -m ping -o 2>/dev/null || echo "  $(RED)Connexion impossible$(NC)"
	@echo ""
	@echo "$(GREEN)ðŸŒ URLs :$(NC)"
	@echo "  WordPress  : https://$(DOMAIN)"
	@echo "  phpMyAdmin : https://$(DOMAIN)/phpmyadmin"
	@echo ""

.PHONY: venv-create
venv-create: ## [util] CrÃ©er un venv local et installer Ansible (compatible Python 3.8+)
	@echo "$(GREEN)>>> CrÃ©ation du virtualenv...$(NC)"
	@python3 -m venv $(VENV_PATH)
	@echo "$(GREEN)>>> Installation d'Ansible...$(NC)"
	@$(VENV_PATH)/bin/pip install --upgrade pip
	@$(VENV_PATH)/bin/pip install "ansible-core<2.17" ansible==9.5.1
	@echo "$(GREEN)âœ… Environnement prÃªt. Activez-le avec : source $(VENV_PATH)/bin/activate$(NC)"
	@echo "$(BLUE)Pour activer le virtualenv, exÃ©cutez :$(NC)"
	@echo "  source $(VENV_PATH)/bin/activate"
