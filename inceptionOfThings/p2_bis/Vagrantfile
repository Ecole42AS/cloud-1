# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # Global configuration
  config.vm.box = "generic/debian12"
  config.vm.box_check_update = false

  # Disable default synced folder (Required for WSL compatibility)
  config.vm.synced_folder ".", "/vagrant", disabled: true

  # WSL2 Specific Configuration: Force Vagrant to use Windows IP for SSH
  if Vagrant::Util::Platform.wsl?
    config.vm.provider :virtualbox do |vb|
      windows_ip = `ip route show default | awk '{print $3}'`.strip # VirtualBox tourne côté Windows, pas côté Linux
      config.ssh.host = windows_ip
    end
  end

  # ----------- Server Node -----------
  config.vm.define "astutzS" do |server|
    server.vm.hostname = "astutzS"
    server.vm.network "private_network", ip: "192.168.56.110"
    
    # Port forwarding for SSH access from WSL
    server.vm.network "forwarded_port", guest: 22, host: 2222, id: "ssh", host_ip: "0.0.0.0", auto_correct: true

    server.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
      vb.cpus = 2
    end

    # Provision files
    server.vm.provision "file", source: "confs", destination: "/home/vagrant/confs"

    server.vm.provision "shell", inline: <<-SHELL
      # Install curl
      apt-get update && apt-get install -y curl

      # Install K3s (Server)
      curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server --node-ip 192.168.56.110 --write-kubeconfig-mode 644" sh -

      # Configure kubectl alias and environment for vagrant user
      echo "alias k='kubectl'" >> /home/vagrant/.bashrc
      echo "export KUBECONFIG=/etc/rancher/k3s/k3s.yaml" >> /home/vagrant/.bashrc

      # Wait for K3s to be ready
      echo "Waiting for K3s to be ready..."
      export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
      while ! /usr/local/bin/kubectl get nodes | grep -q "Ready"; do
        echo "Waiting for K3s..."
        sleep 2
      done

      # Apply manifests
      echo "Deploying applications..."
      export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
      /usr/local/bin/kubectl apply -f /home/vagrant/confs
    SHELL
  end
end
